<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" session="true" %>
<%@ page import="java.sql.*, com.dualaccess.db.DBConnection" %>

<%
if (session == null || session.getAttribute("username") == null) {
    response.sendRedirect("index.jsp");
    return;
}

String department = (String) session.getAttribute("department");
String username = (String) session.getAttribute("username");
String userIP = request.getRemoteAddr(); // optional for display
int remainingDownloads = 5;

try (Connection conn = DBConnection.getConnection()) {
    PreparedStatement stmt = conn.prepareStatement(
        "SELECT COUNT(*) FROM download_log WHERE username=? AND download_time > NOW() - INTERVAL 10 MINUTE");
    stmt.setString(1, username);
    ResultSet rs = stmt.executeQuery();
    if (rs.next()) {
        remainingDownloads = 5 - rs.getInt(1);
        if (remainingDownloads < 0) remainingDownloads = 0;
    }
} catch (Exception e) {
    remainingDownloads = 0; // fallback
}
%>

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Download Files</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body {
            background-image: url("images/background.jpg");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            font-family: Arial, sans-serif;
            padding: 30px 10px;
            min-height: 100vh;
        }

        .container-bg {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .file-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 25px;
            text-align: center;
            transition: 0.3s ease;
            height: 100%;
        }

        .file-card:hover {
            transform: translateY(-5px);
        }

        .file-preview {
            width: 100%;
            height: 180px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #f0f0f0;
        }

        .file-name {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 10px;
            word-break: break-word;
        }

        .download-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            text-decoration: none;
        }

        .download-btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<div class="container container-bg">
    <% String downloadError = (String) session.getAttribute("downloadError"); %>
    <% if (downloadError != null) { %>
        <div class="alert alert-warning alert-dismissible fade show text-center" role="alert">
            ‚ö†Ô∏è <%= downloadError %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <% session.removeAttribute("downloadError"); %>
    <% } %>

    <h3 class="text-center mb-3">Files for <%= department %> Department</h3>
    <p class="text-center text-muted">
        üóÇÔ∏è You can download <strong><%= remainingDownloads %></strong> more file(s) in this 10-minute window.
        <br/>Your IP: <code><%= userIP %></code> <!-- Optional display -->
    </p>

    <div class="row">
    <%
        Connection conn = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        try {
            conn = DBConnection.getConnection();
            ps = conn.prepareStatement("SELECT filename FROM files WHERE department=?");
            ps.setString(1, department);
            rs = ps.executeQuery();

            while (rs.next()) {
                String file = rs.getString("filename");
                String displayName = file.contains("_") ? file.substring(file.indexOf("_") + 1) : file;
                String encodedFile = java.net.URLEncoder.encode(file, "UTF-8");
                String lower = file.toLowerCase();
                boolean isImage = lower.endsWith(".png") || lower.endsWith(".jpg") || lower.endsWith(".jpeg") || lower.endsWith(".gif");
                String previewSrc = isImage ? "DownloadServlet?file=" + encodedFile + "&mode=preview" : "images/file-icon.png";
                String tooltip = (remainingDownloads == 0)
                                 ? "‚õî You have reached your 10-minute download limit."
                                 : "Click to download this file";
    %>
        <div class="col-lg-3 col-md-4 col-sm-6 col-12 d-flex">
            <div class="file-card w-100">
                <img src="<%= previewSrc %>" class="file-preview" alt="Preview" />
                <div class="file-name"><%= displayName %></div>
                <a href="<%= remainingDownloads > 0 ? "DownloadServlet?file=" + encodedFile : "#" %>"
                   class="download-btn btn btn-primary w-100"
                   title="<%= tooltip %>"
                   <%= remainingDownloads == 0 ? "disabled" : "" %>>
                    <i class="bi bi-download"></i> Download
                </a>
            </div>
        </div>
    <%
            }
        } catch (Exception e) {
            out.println("<p class='text-danger text-center'>Error: " + e.getMessage() + "</p>");
        } finally {
            if (rs != null) rs.close();
            if (ps != null) ps.close();
            if (conn != null) conn.close();
        }
    %>
    </div>

    <div class="text-center mt-4">
        <a href="welcome.jsp" class="btn btn-secondary">Back to Dashboard</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Prevent clicking on disabled buttons
    document.querySelectorAll('.download-btn').forEach(btn => {
        btn.addEventListener('click', function (e) {
            if (btn.hasAttribute('disabled')) {
                e.preventDefault();
                alert("‚ö†Ô∏è You have reached the 10-minute download limit.\nPlease wait and try again later.");
            }
        });
    });
</script>
</body>
</html>
